# libcloudph++ User Options Guide (generated by Claude 4.5; not checked for errors)

This document describes all user-configurable options available in the libcloudph++ library for the three microphysics schemes: single-moment bulk, double-moment bulk, and Lagrangian super-droplet method.

## Table of Contents

1. [Single-Moment Bulk Microphysics (blk_1m)](#single-moment-bulk-microphysics-blk_1m)
2. [Double-Moment Bulk Microphysics (blk_2m)](#double-moment-bulk-microphysics-blk_2m)
3. [Lagrangian Microphysics (lgrngn)](#lagrangian-microphysics-lgrngn)
   - [Initialization Options (opts_init_t)](#initialization-options-opts_init_t)
   - [Runtime Options (opts_t)](#runtime-options-opts_t)

---

## Single-Moment Bulk Microphysics (blk_1m)

Defined in: `include/libcloudph++/blk_1m/options.hpp`

The single-moment bulk scheme predicts only the mass mixing ratios of different hydrometeor species.

### Process Control Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `cond` | `bool` | `true` | Enable condensation |
| `cevp` | `bool` | `true` | Enable evaporation of cloud droplets |
| `revp` | `bool` | `true` | Enable evaporation of rain |
| `conv` | `bool` | `true` | Enable autoconversion (cloud → rain) |
| `accr` | `bool` | `true` | Enable accretion (cloud + rain → rain) |
| `sedi` | `bool` | `true` | Enable sedimentation |
| `homA1` | `bool` | `true` | Enable homogeneous nucleation of ice A from water vapor |
| `homA2` | `bool` | `true` | Enable homogeneous nucleation of ice A from cloud droplets |
| `hetA` | `bool` | `true` | Enable heterogeneous nucleation of ice A |
| `hetB` | `bool` | `true` | Enable heterogeneous nucleation of ice B |
| `depA` | `bool` | `true` | Enable depositional growth of ice A |
| `depB` | `bool` | `true` | Enable depositional growth of ice B |
| `rimA` | `bool` | `true` | Enable growth of ice A by riming |
| `rimB` | `bool` | `true` | Enable growth of ice B by riming |
| `melA` | `bool` | `true` | Enable melting of ice A |
| `melB` | `bool` | `true` | Enable melting of ice B |

### Physical Parameters

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `r_c0` | `real_t` | `5e-4` | Autoconversion threshold [kg/kg] |
| `k_acnv` | `real_t` | `0.001` | Kessler autoconversion coefficient (eq. 5a in Grabowski & Smolarkiewicz 1996) |
| `r_eps` | `real_t` | `2e-5` | Absolute tolerance for iterative solvers |

### Numerical Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `adj_nwtrph` | `bool` | `true` | Use simpler Newton-Raphson iteration in saturation adjustment; otherwise use RK4 from boost.odeint |
| `nwtrph_iters` | `int` | `3` | Number of iterations in Newton-Raphson saturation adjustment |
| `th_dry` | `bool` | `true` | If `true`, input/output theta is dry-air potential temperature; if `false`, standard potential temperature |
| `const_p` | `bool` | `false` | If `true`, pressure equals supplied profile (e.g., anelastic model); if `false`, pressure from gas equation |

**Note:** Only tested combinations are: `th_dry=true` & `const_p=false` OR `th_dry=false` & `const_p=true`

---

## Double-Moment Bulk Microphysics (blk_2m)

Defined in: `include/libcloudph++/blk_2m/options.hpp`

The double-moment bulk scheme predicts both mass mixing ratios and number concentrations.

### Process Control Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `acti` | `bool` | `true` | Enable activation |
| `cond` | `bool` | `true` | Enable condensation |
| `acnv` | `bool` | `true` | Enable autoconversion |
| `accr` | `bool` | `true` | Enable accretion |
| `sedi` | `bool` | `true` | Enable sedimentation |

### Physical Parameters

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `RH_max` | `real_t` | `44` | RH limit for activation (anything > 1.1 is sufficient) |
| `acnv_A` | `real_t` | `1350` | Autoconversion parameter A (Khairoutdinov & Kogan 2000, eq. 29) |
| `acnv_b` | `real_t` | `2.47` | Autoconversion parameter b |
| `acnv_c` | `real_t` | `-1.79` | Autoconversion parameter c |

### Aerosol Specification

Aerosol is specified using lognormal modes:

```cpp
struct lognormal_mode_t {
  real_t mean_rd;   // Mean dry radius [m]
  real_t sdev_rd;   // Standard deviation of dry radius [dimensionless]
  real_t N_stp;     // Number concentration at STP [m^-3]
  real_t chem_b;    // Chemical parameter [dimensionless]
};
std::vector<lognormal_mode_t> dry_distros;
```

### Thermodynamic Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `th_dry` | `bool` | `true` | If `true`, input/output theta is dry-air potential temperature; if `false`, standard potential temperature |
| `const_p` | `bool` | `false` | If `true`, pressure equals supplied profile; if `false`, pressure from gas equation |

**Note:** Only working combinations are: `th_dry=true` & `const_p=false` OR `th_dry=false` & `const_p=true`

---

## Lagrangian Microphysics (lgrngn)

The Lagrangian super-droplet method explicitly tracks individual computational particles (super-droplets) representing groups of real droplets with identical properties.

### Initialization Options (opts_init_t)

Defined in: `include/libcloudph++/lgrngn/opts_init.hpp`

These options are set once at initialization and cannot be changed during the simulation.

#### Domain Configuration

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `nx`, `ny`, `nz` | `int` | `0` | Number of Eulerian grid cells in x, y, z directions |
| `dx`, `dy`, `dz` | `real_t` | `1` | Grid spacing [m] |
| `x0`, `y0`, `z0` | `real_t` | `0` | Lower bounds of Lagrangian domain [m] |
| `x1`, `y1`, `z1` | `real_t` | `1` | Upper bounds of Lagrangian domain [m] |
| `dt` | `real_t` | `0` | Timestep [s] |

#### Super-Droplet Configuration

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `sd_conc` | `unsigned long long` | `0` | Number of super-droplets per cell |
| `sd_const_multi` | `unsigned long long` | `0` | Alternative to `sd_conc`: constant multiplicity for all SDs |
| `n_sd_max` | `unsigned long long` | `0` | Maximum number of super-droplets in the system (should account for sources) |
| `sd_conc_large_tail` | `bool` | `false` | Add more SDs to better represent large tail of the distribution |
| `rd_min`, `rd_max` | `real_t` | `-1` | Min/max dry radius of droplets [m]; negative = auto-detect |

#### Aerosol Specification

Two methods are available:

**1. Distribution-based (recommended):**
```cpp
typedef std::unordered_map<
  real_t,  // kappa (hygroscopicity parameter)
  std::shared_ptr<unary_function<real_t>>  // n(ln(rd)) @ STP
> dry_distros_t;
dry_distros_t dry_distros;
```

**2. Size-number pairs:**
```cpp
typedef std::map<
  real_t,  // kappa
  std::map<real_t,  // radius [m]
    std::pair<real_t, int>  // STP concentration [1/m^3], number of SDs
  >
> dry_sizes_t;
dry_sizes_t dry_sizes;
```

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `aerosol_independent_of_rhod` | `bool` | `false` | If `true`, aerosol concentration in cm^-3 (not at STP) |

#### Timestep Substepping

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `sstp_cond` | `int` | `1` | Number of condensation substeps (or max if adaptive) |
| `sstp_coal` | `int` | `1` | Number of coalescence substeps |
| `sstp_chem` | `int` | `1` | Number of chemistry substeps |
| `sstp_cond_act` | `int` | `1` | Number of condensation substeps for activating/deactivating SDs (adaptive mode only) |
| `exact_sstp_cond` | `bool` | `false` | If `true`, use per-particle substepping; if `false`, per-cell |
| `sstp_cond_mix` | `bool` | `true` | If `true`, mix th/rv of all SDs in cell after each substep; if `false`, only after all substeps |
| `adaptive_sstp_cond` | `bool` | `false` | If `true`, use adaptive number of condensation substeps |
| `sstp_cond_adapt_drw2_eps` | `real_t` | `1e-4` | Tolerance for adaptive substepping: drw2_err ≤ eps × rw2 |
| `sstp_cond_adapt_drw2_max` | `real_t` | `4` | Maximum drw2: drw2 < max × rw2 |
| `variable_dt_switch` | `bool` | `false` | Allow changing dt during simulation through `opts.dt` |

**Note:** If `dt` changes during simulation and substeps > 1, the number of substeps is adjusted to keep process timestep close to `dt/sstp`.

#### Process Switches

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `chem_switch` | `bool` | `false` | Enable chemical reactions (affects memory allocation) |
| `coal_switch` | `bool` | `true` | Enable coalescence |
| `sedi_switch` | `bool` | `true` | Enable sedimentation |
| `subs_switch` | `bool` | `false` | Enable subsidence |
| `rlx_switch` | `bool` | `false` | Enable aerosol relaxation |
| `turb_adve_switch` | `bool` | `false` | Enable turbulent advection of SDs |
| `turb_cond_switch` | `bool` | `false` | Enable turbulent condensation |
| `turb_coal_switch` | `bool` | `false` | Enable turbulent coalescence kernels |

#### Physical Parameterizations

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `kernel` | `kernel_t` | `undefined` | Coalescence kernel type (e.g., `geometric`, `hall`, `onishi`, `electric`) |
| `kernel_parameters` | `std::vector<real_t>` | - | Parameters for selected kernel |
| `terminal_velocity` | `vt_t` | `undefined` | Terminal velocity formula (e.g., `beard`, `khvorostyanov`, `beard_relaxation`) |
| `adve_scheme` | `as_t` | `implicit` | SD advection scheme (`implicit`, `euler`, `pred_corr`) |
| `RH_formula` | `RH_formula_t` | `pv_cc` | RH formula (`pv_cc`, `rv_cc`, `pv_tet`, `rv_tet`) |
| `RH_max` | `real_t` | `0.95` | RH threshold for equilibrium at t=0 (suggested: Lebo & Seinfeld 2011) |
| `rc2_T` | `real_t` | `10` | Temperature [°C] at which critical radius is calculated |

#### Boundary Conditions

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `open_side_walls` | `bool` | `false` | If `true`, SDs removed at side walls; if `false`, periodic |
| `periodic_topbot_walls` | `bool` | `false` | If `true`, top/bottom walls periodic; if `false`, open |

#### Environmental Profiles

| Option | Type | Description |
|--------|------|-------------|
| `w_LS` | `std::vector<real_t>` | Subsidence rate profile [m/s], positive downwards |
| `SGS_mix_len` | `std::vector<real_t>` | SGS mixing length profile [m] |
| `aerosol_conc_factor` | `std::vector<real_t>` | Profile of aerosol concentration scaling factor |

#### Chemistry Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `chem_rho` | `real_t` | `0` | Dry particle density [kg/m^3] |

#### Diagnostics

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `diag_incloud_time` | `bool` | `false` | Track time SDs spend inside clouds |

#### Random Number Generation

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `rng_seed` | `int` | `44` | RNG seed for stochastic processes |
| `rng_seed_init` | `int` | `44` | RNG seed for SD initialization (positions, dry sizes) |
| `rng_seed_init_switch` | `bool` | `false` | Use separate RNG seed for initialization |

#### GPU Configuration

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `dev_count` | `int` | `0` | Number of GPUs per MPI node to use (0 = all available) |
| `dev_id` | `int` | `-1` | GPU number to use (CUDA backend only, not multi_CUDA) |

#### Initialization Control

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `no_ccn_at_init` | `bool` | `false` | If `true`, no CCN/SD created at start of simulation |

#### Thermodynamic Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `th_dry` | `bool` | `true` | If `true`, theta is dry-air potential temperature; if `false`, standard |
| `const_p` | `bool` | `false` | If `true`, pressure from profile; if `false`, from gas equation |

**Note:** Only tested combinations are: `th_dry=true` & `const_p=false` OR `th_dry=false` & `const_p=true`

#### Aerosol Source Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `src_type` | `src_t` | `off` | Type of CCN source (`off`, `constant`, etc.) |
| `src_dry_distros` | `dry_distros_t` | - | Source distribution per unit time |
| `src_dry_sizes` | `dry_sizes_t` | - | Alternative source specification using size-number pairs |
| `src_sd_conc` | `unsigned long long` | `0` | Number of SDs created per cell per source iteration |
| `src_x0`, `src_x1` | `real_t` | `0` | Source box x-boundaries [m] (rounded to cell boundaries) |
| `src_y0`, `src_y1` | `real_t` | `0` | Source box y-boundaries [m] |
| `src_z0`, `src_z1` | `real_t` | `0` | Source box z-boundaries [m] |
| `supstp_src` | `int` | `1` | Timestep interval for applying source |

#### Aerosol Relaxation Options

| Option | Type | Description |
|--------|------|-------------|
| `rlx_dry_distros` | `rlx_dry_distros_t` | Relaxation distributions with kappa, distribution, kappa range, and altitude range |
| `rlx_bins` | `unsigned long long` | Number of bins for dividing relaxation distribution |
| `rlx_sd_per_bin` | `real_t` | Number of SDs created per bin (float, divided by GPUs × nodes) |
| `rlx_timescale` | `real_t` | Relaxation time scale [s] |
| `supstp_rlx` | `int` | Timestep interval for applying relaxation |

---

### Runtime Options (opts_t)

Defined in: `include/libcloudph++/lgrngn/opts.hpp`

These options can be changed at each timestep during the simulation.

#### Process Control

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `adve` | `bool` | `true` | Enable advection |
| `sedi` | `bool` | `true` | Enable sedimentation |
| `subs` | `bool` | `false` | Enable subsidence |
| `cond` | `bool` | `true` | Enable condensation |
| `coal` | `bool` | `true` | Enable coalescence |
| `src` | `bool` | `false` | Enable aerosol source |
| `rlx` | `bool` | `false` | Enable aerosol relaxation |
| `rcyc` | `bool` | `false` | Enable recycling |
| `turb_adve` | `bool` | `false` | Enable turbulent advection |
| `turb_cond` | `bool` | `false` | Enable turbulent condensation |
| `turb_coal` | `bool` | `false` | Enable turbulent coalescence |

#### Chemistry Process Control

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `chem_dsl` | `bool` | `false` | Enable chemical dissolution |
| `chem_dsc` | `bool` | `false` | Enable chemical dissociation |
| `chem_rct` | `bool` | `false` | Enable chemical reactions |

#### Physical Parameters

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `RH_max` | `real_t` | `44` | RH limit for drop growth (anything > 1.1 is sufficient) |
| `dt` | `real_t` | `-1` | Override dt from `opts_init`; negative = use `opts_init.dt` |

---

## Usage Examples

### Single-Moment Bulk

```cpp
#include <libcloudph++/blk_1m/options.hpp>

libcloudphxx::blk_1m::opts_t<double> opts;
opts.cond = true;          // Enable condensation
opts.conv = true;          // Enable autoconversion
opts.accr = true;          // Enable accretion
opts.r_c0 = 5e-4;          // Autoconversion threshold
opts.k_acnv = 0.001;       // Kessler parameter
opts.th_dry = true;        // Use dry potential temperature
opts.const_p = false;      // Variable pressure
```

### Double-Moment Bulk

```cpp
#include <libcloudph++/blk_2m/options.hpp>

libcloudphxx::blk_2m::opts_t<double> opts;
opts.acti = true;          // Enable activation
opts.cond = true;          // Enable condensation
opts.RH_max = 44;          // RH limit

// Define aerosol mode
libcloudphxx::blk_2m::opts_t<double>::lognormal_mode_t mode;
mode.mean_rd = 0.04e-6;    // 40 nm
mode.sdev_rd = 1.4;        // Standard deviation
mode.N_stp = 60e6;         // 60 cm^-3 at STP
mode.chem_b = 0.61;        // Kappa
opts.dry_distros.push_back(mode);
```

### Lagrangian Microphysics

```cpp
#include <libcloudph++/lgrngn/opts_init.hpp>
#include <libcloudph++/lgrngn/opts.hpp>

// Initialization options
libcloudphxx::lgrngn::opts_init_t<double> opts_init;
opts_init.nx = 100;
opts_init.ny = 100;
opts_init.nz = 100;
opts_init.dx = opts_init.dy = opts_init.dz = 10;  // 10 m grid spacing
opts_init.dt = 1.0;                                 // 1 s timestep
opts_init.sd_conc = 64;                            // 64 SDs per cell
opts_init.sstp_cond = 4;                           // 4 condensation substeps
opts_init.adaptive_sstp_cond = true;               // Enable adaptive substepping
opts_init.exact_sstp_cond = true;                  // Per-particle substepping
opts_init.kernel = libcloudphxx::lgrngn::kernel_t::geometric;
opts_init.terminal_velocity = libcloudphxx::lgrngn::vt_t::beard;

// Define aerosol distribution
auto lognormal = [](double lnr) {
  double mean_r = 0.04e-6;
  double stdev = 1.4;
  double n_tot = 60e6;
  return n_tot * exp(-pow((lnr - log(mean_r)), 2) / 2 / pow(log(stdev), 2))
         / log(stdev) / sqrt(2 * M_PI);
};
opts_init.dry_distros[0.61] = std::make_shared<decltype(lognormal)>(lognormal);

// Runtime options (can change each step)
libcloudphxx::lgrngn::opts_t<double> opts;
opts.cond = true;
opts.coal = true;
opts.sedi = true;
opts.RH_max = 1.1;
```

---

## References

- Grabowski, W. W., & Smolarkiewicz, P. K. (1996). Two-time-level semi-Lagrangian modeling of precipitating clouds. *Monthly Weather Review*, 124(3), 487-497.
- Khairoutdinov, M., & Kogan, Y. (2000). A new cloud physics parameterization in a large-eddy simulation model of marine stratocumulus. *Monthly Weather Review*, 128(1), 229-243.
- Lebo, Z. J., & Seinfeld, J. H. (2011). Theoretical basis for convective invigoration due to increased aerosol concentration. *Atmospheric Chemistry and Physics*, 11(11), 5407-5429.
- Arabas, S., Jaruga, A., Pawlowska, H., & Grabowski, W. W. (2015). libcloudph++ 1.0: a single-moment bulk, double-moment bulk, and particle-based warm-rain microphysics library in C++. *Geoscientific Model Development*, 8(6), 1677-1707.

For more information, see: https://github.com/igfuw/libcloudphxx/wiki
